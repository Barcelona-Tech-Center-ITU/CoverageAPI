upstream key_service {
    server key-service:8000;
}

upstream data_service {
    server data-service:8000;
}

upstream upload_service {
    server upload-service:8000;
}

server {
    listen 80;
    server_name localhost;

    # Increase client max body size for file uploads
    client_max_body_size 100M;

    # Key service routing
    location /api/generate-key {
        proxy_pass http://key_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Data service routing
    location /api/send-data {
        proxy_pass http://data_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Upload service routing
    location /api/test-data-upload {
        proxy_pass http://upload_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Increase timeouts for upload processing
        proxy_read_timeout 300;
        proxy_connect_timeout 300;
        proxy_send_timeout 300;
    }

    # Health checks and service discovery
    location /health/key {
        proxy_pass http://key_service/health;
    }

    location /health/data {
        proxy_pass http://data_service/health;
    }

    location /health/upload {
        proxy_pass http://upload_service/health;
    }

    # Data service stats endpoint
    location /stats {
        proxy_pass http://data_service/stats;
    }

    # Root endpoint - return API information
    location / {
        return 200 '{"message":"GIGA Coverage API","version":"1.0.0","endpoints":["/api/generate-key","/api/send-data","/api/test-data-upload"],"health":["/health/key","/health/data","/health/upload"]}';
        add_header Content-Type application/json;
    }
}